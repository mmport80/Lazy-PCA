<!--
    (c)2015 John Orford
    
    This file is part of Lazy PCA.

    Lazy PCA is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    Lazy PCA is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with Lazy PCA.  If not, see <http://www.gnu.org/licenses/>.
 xoxo
-->


<html>
<head>
        <script type="text/javascript" src="lazy.js"></script>
        <script type="text/javascript" src="networking.js"></script>
        <script type="text/javascript" src="utility.js"></script>
        <script type="text/javascript" src="jstat.min.js"></script>
        <script type="text/javascript" src="numeric-1.2.6.min.js"></script>
        <script type="text/javascript" src="d3.v3.min.js"></script>
        <style>

                body {
                        font: 1em;
                        }

                .axis path,
                .axis line {
                        fill: none;
                        stroke: #000;
                        shape-rendering: crispEdges;
                        }

                .dot {
                        stroke: #000;
                        }
                #title{
                        font-size: 6em;
                        }

        </style>
        <title>Lazy PCA. Break down time series into mean reversion and momentum components.</title>
</head>
<body>

        <div id="title">Lazy PCA</div>

        <hr />  
        <!--process data also, and display new graph when possible...-->
        <p>1) Set the horizon</p>
        
        <div>   
                <select id='horizon'>
                        <option value='1'>Daily</option>
                        <option value='5'>Weekly</option>
                        <option value='21' selected="selected">Monthly</option>
                        <option value='63'>Quarterly</option>
                </select>
        </div>

        
        

        <hr />
        
        <p>2) Pull required data down from <a href='https://www.quandl.com/'>Quandl</a> by specifying sources and tickers</p>

        
        <div>
                <select id='source' autocomplete="on">
                        <option value='GOOG'>GOOG</option>
                        <option value='YAHOO' selected="selected">YAHOO</option>
                        <option value='CBOE'>CBOE</option>
                </select>
                <input type="text" id='ticker' value='INDEX_VIX'/>
                Yield
                <input type="checkbox" id="yield" value="true" autocomplete="on"/>
                
        </div>
        <hr />
        <div>
                <p>Optional: filter by date</p>
                <!--
                off by default
                populated by current start / end dates once data is loaded
                reprocess 
                 -->
                Start <input type="date" id='startDate' disabled='true'/>
                End <input type="date" id='endDate' disabled='true'/>
        </div>
        <hr />
        <p>
                <a href='javascript:void(0)' id='submit'>Submit</a>
        </p>
        <hr />
        <div id = 'plot'></div>
        
        <hr />
        <p>Optional: input a Quandl key for unlimited & free data</p>
        <div>                
                <input type="password" id='key' autocomplete="on"/>
        </div>
        <hr />
        <p>Need help? Watch the screencast!<p>
        <iframe width="960" height="720" src="https://www.youtube-nocookie.com/embed/SnAsmKgWQLI?rel=0" frameborder="0" allowfullscreen></iframe>
</body>

        <script>
                "use strict"

                var sampling = +document.getElementById('horizon').value;
        
                //*****************************************************
                
                function formatDate(date) {
                    var d = new Date(date),
                        month = '' + (d.getMonth() + 1),
                        day = '' + d.getDate(),
                        year = d.getFullYear();

                    if (month.length < 2) month = '0' + month;
                    if (day.length < 2) day = '0' + day;

                    return [year, month, day].join('-');
                }
                
                //*****************************************************
                
                var globalData = null;
                
                
                
                
                
                
                //*****************************************************
                
                
                document.getElementById('submit')
                        .addEventListener("click", 
                                function(){
                                        //remove svg
                                        d3.select("svg").remove();
                                        var globalData = getData(document.getElementById('source').value,document.getElementById('ticker').value);
                                        
                                        var e = globalData.processData();
                                        getScatterPlot(e.pss, e.result);
                                        
                                        document.getElementById('startDate').disabled = false;
                                        document.getElementById('endDate').disabled = false;
                                        
                                        //seperate, so that refreshes whenever new data is coming in...
                                        document.getElementById('startDate').value === "" ? 
                                                document.getElementById('startDate').value = formatDate(e.pss[0][e.pss[0].length-1].date)
                                                : 
                                                null;
                                        
                                        document.getElementById('endDate').value === "" ? 
                                                document.getElementById('endDate').value = formatDate(e.pss[0][0].date)
                                                : 
                                                null;
                                        }
                                );

                //*****************************************************


                function setHorizonListener(){
                        sampling = +document.getElementById('horizon').value;
                        }


                //after pushing 'calc' button
                //changehorizon, means changing clean data also - if not []
                document
                        .getElementById('horizon')
                        .addEventListener("change", 
                                function(){ 
                                        setHorizonListener();
                                        }
                                );
                
                //*****************************************************

                function setStartDateListener(){
                        startDate = new Date(document.getElementById('startDate').value);
                        }

                document
                        .getElementById('startDate')
                        .addEventListener("change", 
                                function(){ 
                                        setStartDateListener();
                                        }
                                );
                                
                
                //*****************************************************

                function setEndDateListener(){
                        endDate = new Date(document.getElementById('endDate').value);
                        }

                document
                        .getElementById('endDate')
                        .addEventListener("change", 
                                function(){ 
                                        setEndDateListener();
                                        }
                                );
                                
                //*****************************************************
                //get data
                //process data
                //draw chart
                         
                function getData(source,ticker){
                        return getQuandlData(source,ticker)
                                .take(1)
                                .value()[0]
                                .map(
                                        function(i){
                                                var r = null;
                                                document.getElementById('yield').checked == true ?
                                                        r = {date: new Date(i[0]), datum:i[1].yieldToDsft()} 
                                                        :
                                                        r = {date: new Date(i[0]), datum:i[1]};
                                                return r;
                                                }
                                        );
                        }
                 
                //*****************************************************
                var startDate = new Date('1912-06-01');
                var endDate = new Date('2125-05-15');

                var processData = function(){

                        var d = this.filter(
                                function(i,j){
                                        return j % sampling === 0 && (i.date >= startDate) && (i.date <= endDate);
                                        }
                                );
                                
                        //filter by monthly, etc. returns
                        //create another vector or arrays, zip up at the end...?
                        //[before, after]
                        var pss = [Lazy(d).last(d.length-1).toArray(), Lazy(d).take(d.length-1).toArray()]
                                .map(
                                        function(i){
                                                return i.returns();//
                                                }
                                        );
                        
                        var pss_demeaned = pss
                                .map(
                                        function(i){
                                                return i.deMean();
                                                }
                                        );
                        
                        var vcv = numeric.dot(pss_demeaned,numeric.transpose(pss_demeaned));
                        
                        var vcv_normed = numeric.mul(vcv,1/(pss_demeaned[0].length-1));
                        
        	        var result = numeric.eig(vcv_normed);
                              
                        return {pss:pss,result:result};
                        }

                Object.defineProperty(
                        Object.prototype, 
                        'processData',
                        {
                                value: processData,
                                writable: true,
                                configurable: true,
                                enumerable: false
                                }
                        );
                               
                
                //*****************************************************
        
                Number.prototype.roundTwo = function() {
                        return Math.round(this*100) / 100;
                        }
                        
                function getScatterPlot(data, svdResult){
                                       
                        var mean = data.map(function(i){return jStat( Lazy(i).pluck('datum').toArray() ).mean();});
                                       
                        data = Lazy(data[0]).zip(data[1]).map(function(i){return {date:i[1].date.toLocaleDateString(), before:i[0].datum,after:i[1].datum};}).toArray();
                                        
                        var margin = {top: 20, right: 20, bottom: 50, left: 50},
                            width = window.innerHeight*0.75 - margin.left - margin.right,
                            height = window.innerHeight*0.75 - margin.top - margin.bottom;

                        var x = d3.scale.linear()
                            .range([0, width]);

                        var y = d3.scale.linear()
                            .range([height, 0]);

                        var color = d3.scale.category10();



                        var xAxis = d3.svg.axis()
                            .scale(x)
                            .orient("bottom");

                        var yAxis = d3.svg.axis()
                            .scale(y)
                            .orient("left");

                        x.domain(d3.extent(data, function(d) { return d.before + mean[0]; })).nice();
                        y.domain(d3.extent(data, function(d) { return d.after + mean[1]; })).nice();


                        
                        x.domain()[1].print();
                        y.domain()[1].print();
                        
                        var formatXLabel = function(d){
		                if (d.toLocaleString() === x.domain()[1].toLocaleString() ){
		                        return (d*100).toLocaleString()+"%";
			                }
		                else {
		                        return (d * 100).toLocaleString();
			                }
		                }

                        var formatYLabel = function(d){
		                if (d.toLocaleString() === y.domain()[1].toLocaleString() ){
		                        return (d*100).toLocaleString()+"%";
			                }
		                else {
		                        return (d * 100).toLocaleString();
			                }
		                }


                        var svg = d3.select("#plot").append("svg")
                                .attr("width", width + margin.left + margin.right)
                                .attr("height", height + margin.top + margin.bottom)
                                .append("g")
                                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


                        svg.append("g")
                                .attr("class", "x axis")
                                .attr("transform", "translate(0," + height + ")")
                                .call(xAxis.tickFormat( formatXLabel ) )
                                .append("text")
                                .attr("class", "label")
                                .attr("x", width)
                                .attr("y", -6)
                                .style("text-anchor", "end")
                                .text("Before");

                        svg.append("g")
                                .attr("class", "y axis")
                                .call(yAxis.tickFormat( formatXLabel ) )
                                .append("text")
                                .attr("class", "label")
                                .attr("transform", "rotate(-90)")
                                .attr("y", 6)
                                .attr("dy", ".71em")
                                .style("text-anchor", "end")
                                .text("After");


                        svg.selectAll(".dot")
                                .data(data)
                                .enter().append("circle")
                                .attr("class", "dot")
                                .attr("r", 12)
                                .attr("cx", function(d) { return x( d.before+mean[0]  ); })
                                .attr("cy", function(d) { return y( d.after+mean[1]  ); })
                                .style("fill", "green")
                                .style("fill-opacity", 0.25)
                                .style("stroke", "none")
                                .append("title")
                                .text(function(d) { return "Date: "+d.date+"; period before: "+(100*d.before).toLocaleString()+"%; after: "+(100*d.after).toLocaleString()+"%"; });
                        
                        var rotateBy = Math.atan2( svdResult.E.x[0][0], svdResult.E.x[0][1] ) * 180 / Math.PI;
                        
                        rotateBy.print();
                        
                        var radiiLabels = [];
                        
                        rotateBy > -46 ? radiiLabels = ["Momentum","Mean Reversion"] : radiiLabels = ["Mean Reversion","Momentum"];
                        
                        svg     .append("ellipse")
                                .attr("class", "dot")
                                .attr("cx",function(d) { return x( mean[0] ); })
                                .attr("cy",function(d) { return y( mean[1] ); })
                                .attr("rx",function(d) {
                                                        return x( x.domain()[0]+Math.sqrt( svdResult.lambda.x[0] ) ); 
                                                        })
                                .attr("ry",function(d) { 
                                                        return y( y.domain()[1]-Math.sqrt( svdResult.lambda.x[1] ) );
                                                        })
                                .style("stroke", "black")
                                .style("stroke-opacity", 0.50)
                                .style("stroke-width","8px")
                                .style("fill", "none")
                                .attr("transform", "rotate("+rotateBy+", "+x( mean[0] )+", "+y( mean[1] )+")")
                                .append("title")
                                .text(function(d) { return      "Mean "+ (100*mean[0]).toLocaleString() + "%; " +
                                                                radiiLabels[0]+": "    + Math.abs(100*Math.sqrt( svdResult.lambda.x[0] )).toLocaleString() + "%; " +
                                                                radiiLabels[1]+": "    + Math.abs(100*-Math.sqrt( svdResult.lambda.x[1] )).toLocaleString() + "% "
                                                                ; });

                        var legend = svg.selectAll(".legend")
                                .data(color.domain())
                                .enter().append("g")
                                .attr("class", "legend")
                                .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

                        legend.append("rect")
                                .attr("x", width - 18)
                                .attr("width", 18)
                                .attr("height", 18)
                                .style("fill", color);

                        legend.append("text")
                                .attr("x", width - 24)
                                .attr("y", 9)
                                .attr("dy", ".35em")
                                .style("text-anchor", "end")
                                .text(function(d) { return d; });

                                
                        }              
                
                //*****************************************************
                
                //auto play
                var d = getData(document.getElementById('source').value,document.getElementById('ticker').value);
                var e = d.processData();
                getScatterPlot(e.pss, e.result);
                
        </script>






</html>
